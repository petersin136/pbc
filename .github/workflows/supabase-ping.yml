name: Supabase Keep-Alive Ping

# GitHub Secrets 설정 방법:
# 1. GitHub 저장소 페이지로 이동
# 2. Settings > Secrets and variables > Actions 클릭
# 3. "New repository secret" 버튼 클릭
# 4. 다음 두 개의 Secret 추가:
#    - Name: SUPABASE_URL
#      Value: https://your-project-id.supabase.co
#    - Name: SUPABASE_ANON_KEY
#      Value: your-anon-key (Supabase 대시보드 > Settings > API에서 확인)
# 5. 각 Secret 저장 후 워크플로우가 자동으로 사용 가능

on:
  # 매주 월요일, 목요일 오전 9시(UTC) 자동 실행
  schedule:
    - cron: '0 9 * * 1,4' # 월요일(1), 목요일(4) 오전 9시 UTC
  # 수동 실행 가능
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Ping Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Pinging Supabase to prevent auto-pause..."
          
          # 간단한 SELECT 쿼리로 DB 활성화
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            "${SUPABASE_URL}/rest/v1/sections?select=id&limit=1")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 206 ]; then
            echo "✅ Supabase ping successful! (HTTP $http_code)"
            echo "Response: $body"
          else
            echo "❌ Supabase ping failed! (HTTP $http_code)"
            echo "Response: $body"
            exit 1
          fi

